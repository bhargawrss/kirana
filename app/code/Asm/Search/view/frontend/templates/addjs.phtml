<?php
/**
 * @category   Asm
 * @package    Asm_Search
 * @author     sunilnalawade15@gmail.com
 * @copyright  This file was generated by using Module Creator(http://code.vky.co.in/magento-2-module-creator/) provided by VKY <viky.031290@gmail.com>
 * @license    http://opensource.org/licenses/osl-3.0.php  Open Software License (OSL 3.0)
 */
?>
<?php
// Get base url
$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$storeManager = $objectManager->get('\Magento\Store\Model\StoreManagerInterface');
$baseUrl = $storeManager->getStore()->getBaseUrl();
// Get session data
$customerSession = $objectManager->create('Magento\Framework\Session\SessionManagerInterface');
$sessionLat = $customerSession->getLatitude();
$sessionLng = $customerSession->getLongitude();
$sessionCustlgin = $customerSession->getCustmerloginstatus();
$sessionFullAdd = $customerSession->getFulladdress();
// print_r($customerSession->getLatitude());
// print_r($customerSession->getLongitude());
// print_r($customerSession->getCustmerloginstatus());exit;
// print_r($customerSession->getFulladdress());
// //print_r($baseUrl);
?>
<script type="text/javascript">
require([
"jquery",
"jquery/jquery.cookie"
], function($, modal){
    $(document).ready(function() {
        var sessionLat = "<?php if(isset($sessionLat)){ echo $sessionLat; }else{  echo 'null'; } ?>";
        var sessionLng = "<?php if(isset($sessionLng)){ echo $sessionLng; }else{ echo 'null'; } ?>";
        var sessionCustlgin = "<?php if(isset($sessionCustlgin)){ echo $sessionCustlgin; }else{ echo 'null'; } ?>";
        var sessionFullAdd = "<?php if(isset($sessionFullAdd)){ echo $sessionFullAdd; }else{ echo 'null'; } ?>";
        console.log(sessionLat+'--'+sessionLng+'--'+sessionCustlgin+'--'+sessionFullAdd);


       // Customer is login 
        if(jQuery('#customerLogin').val()){
            var sessionCustlgin = 'false';
                var geocoder = new google.maps.Geocoder();
                var addressLog = jQuery('#addressFull').val();
                 // Get Default Logedin User Address
                geocoder.geocode( { 'address': addressLog}, function(results, status) {
                    console.log(status);
                
                if (status == google.maps.GeocoderStatus.OK) 
                {
                    $('#defaultAdd').html(addressLog);
                    $('#defaultAddval').val(addressLog);
                    addresslatitude =  results[0].geometry.location.lat();
                    addresslongitude = results[0].geometry.location.lng();
                    //console.log(addresslatitude);
                    //console.log(addresslongitude);
                } 
                console.log("lat-->"+sessionLat+"=="+addresslatitude);
                console.log("lng-->"+sessionLng+"=="+addresslongitude);
                console.log("sessionCustlgin-->"+sessionCustlgin);
                if(sessionLat != addresslatitude && sessionLng != addresslongitude && sessionCustlgin == 'false'){
                    //console.log("Save session");
                        console.log("lat--"+addresslatitude);
                        console.log("lng--"+addresslongitude);
                        $("#lat").val(addresslatitude);
                        $("#lng").val(addresslongitude);
                        custmerloginstatus = true;
                        clearCart();
                        setsession(addresslatitude, addresslongitude, custmerloginstatus, addressLog);
                    }  
                });
        }

        function setsession(latitude, longitude, custmerloginstatus, address){
            if(latitude != '' && longitude != '' && custmerloginstatus != ''){
            var param = 'latitude='+latitude+'&longitude='+longitude+'&custmerloginstatus='+custmerloginstatus+'&fulladdress='+address;
                jQuery.ajax({
                    showLoader: true,
                    url: "<?php  echo $baseUrl; ?>search/index/session",
                    data: param,
                    type: "POST",
                    dataType: 'json',
                }).done(function (data) {
                    // console.log(data);
                    if(data.message == 'Success')
                    {
                        console.log("Set session data.");
                        // window.location.reload(true);
                        window.location.href="<?php echo '?time='.time(); ?>";
                    }
                    else
                    {
                        console.log("some problem to set session data");
                    }
                });
            } //endif
        }//end function setsession
        //Clear cart
        function clearCart(){
            jQuery.ajax({
                 url: '<?php  echo $baseUrl; ?>search/index/clearcart',
                 type: 'POST',
                 showLoader: true,
                success: function (res) {
                     if (res.messages) {
                         jQuery('[data-placeholder="messages"]').html(res.messages);
                     }
                    // if (res.minicart) {
                    //     jQuery('[data-block="minicart"]').replaceWith(res.minicart);
                    //     jQuery('[data-block="minicart"]').trigger('contentUpdated');
                    // }
                 }
             });
        }//End clear cart

    });
});

</script>
