<?php
/**
 * @category   Asm
 * @package    Asm_Search
 * @author     sunilnalawade15@gmail.com
 * @copyright  This file was generated by using Module Creator(http://code.vky.co.in/magento-2-module-creator/) provided by VKY <viky.031290@gmail.com>
 * @license    http://opensource.org/licenses/osl-3.0.php  Open Software License (OSL 3.0)
 */
?>
<?php
// Get base url
$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$storeManager = $objectManager->get('\Magento\Store\Model\StoreManagerInterface');
$baseUrl = $storeManager->getStore()->getBaseUrl();
// Get session data
$customerSession = $objectManager->create('Magento\Framework\Session\SessionManagerInterface');
$sessionLat = $customerSession->getLatitude();
$sessionLng = $customerSession->getLongitude();
$sessionCustlgin = $customerSession->getCustmerloginstatus();
$sessionFullAdd = $customerSession->getFulladdress();
// print_r($customerSession->getLongitude());exit;
// print_r($customerSession->getCustmerloginstatus());
//print_r($baseUrl);
?>
<script type="text/javascript">
require([
"jquery",
"Magento_Ui/js/modal/modal",
"jquery/jquery.cookie"
], function($, modal){
    $(document).ready(function() {
        var sessionLat = "<?php if(isset($sessionLat)){ echo $sessionLat; }else{  echo 'null'; } ?>";
        var sessionLng = "<?php if(isset($sessionLng)){ echo $sessionLng; }else{ echo 'null'; } ?>";
        var sessionCustlgin = "<?php if(isset($sessionCustlgin)){ echo $sessionCustlgin; }else{ echo 'null'; } ?>";
        var sessionFullAdd = "<?php if(isset($sessionFullAdd)){ echo $sessionFullAdd; }else{ echo 'null'; } ?>";
        console.log(sessionLat+'--'+sessionLng+'--'+sessionCustlgin+'--'+sessionFullAdd);
        var latitudeAndLongitude=document.getElementById("lat"),
        location={
            latitude:'',
            longitude:''
        };
        //var flag;
        if (navigator.geolocation){
                if(sessionLat == 'null' && sessionLng == 'null'){
                    navigator.geolocation.getCurrentPosition(showPosition);
                }
        }
        else{
            //console.log("hererre");
        latitudeAndLongitude.innerHTML="Geolocation is not supported by this browser.";
        }

       

        function showPosition(position){ 
            // console.log(position);
            location.latitude=position.coords.latitude;
            location.longitude=position.coords.longitude;
                $("#lat").val(position.coords.latitude);
                $("#lng").val(position.coords.longitude);
                var latitude = $('#lat').val();
                var longitude = $('#lng').val();
                var custmerloginstatus = 'false';
                var address = '';
                 // $.cookie('latitude', latitude );
                 // $.cookie('longitude', longitude );
                 // $.cookie('custmerloginstatus', 'false' );
                 // console.log($.cookie('latitude')+'--'+$.cookie('longitude'));

            var geocoder = new google.maps.Geocoder();
            var latLng = new google.maps.LatLng(location.latitude, location.longitude);

            if (geocoder) {
                geocoder.geocode({ 'latLng': latLng}, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    address = results[0].formatted_address;
                    //Set session
                    setsession(latitude, longitude, custmerloginstatus, address);
                    //flag = true;
                    //$('#address').html('Address:'+results[0].formatted_address);
                }
                else {
                    //flag = false;
                    //$('#address').html('Geocoding failed: '+status);
                    console.log("Geocoding failed: " + status);
                }
                }); //geocoder.geocode()
            }   
            

        } //showPosition

       // Customer is login 
        if(jQuery('#customerLogin').val()){
            //if($.cookie('latitude') == '' && $.cookie('longitude') == ''){
                var geocoder = new google.maps.Geocoder();
                var addressLog = jQuery('#addressFull').val();
                 var latLng = new google.maps.LatLng(sessionLat, sessionLng);
                 geocoder.geocode( { 'latLng': latLng}, function(results, status) {
                       if (status == google.maps.GeocoderStatus.OK) {
                        $('#currentAdd').html(results[0].formatted_address);
                        $('#currentAddval').val(results[0].formatted_address);
                      }
                    });
                 // Get Default Logedin User Address
                geocoder.geocode( { 'address': addressLog}, function(results, status) {
                    console.log(status);
                
                if (status == google.maps.GeocoderStatus.OK) 
                {
                    $('#defaultAdd').html(addressLog);
                    $('#defaultAddval').val(addressLog);
                    addresslatitude =  results[0].geometry.location.lat();
                    addresslongitude = results[0].geometry.location.lng();
                } 
                    //console.log($.cookie('custmerloginstatus'));
                    if(sessionLat != addresslatitude && sessionLng != addresslongitude && sessionCustlgin == 'false'){
                        var popup = modal(optionsnew, $('#popup-modal-islogin'));
                            $('#popup-modal-islogin').modal('openModal');
                    }else{
                        $("#lat").val(addresslatitude);
                        $("#lng").val(addresslongitude); 
                    }   
                });
             //}
        }
        // Rgister user or non registered user popup
         var options = {
                type: 'popup',
                responsive: true,
                innerScroll: true,
                title: 'Address',
                modalClass: 'custom-modal',
                buttons: [{
                    text: $.mage.__('Continue'),
                    class: 'getaddressdetails',
                    click: function () {
                        var address = jQuery('#autocomplete').val();
                           var geocoder = new google.maps.Geocoder();
                            //var address = "new york";
                            geocoder.geocode( { 'address': address}, function(results, status) {
                              //console.log('status-->'+status);
                               if (status == google.maps.GeocoderStatus.OK) {
                                var latitude = results[0].geometry.location.lat();
                                var longitude = results[0].geometry.location.lng();
                                var custmerloginstatus = 'false';
                                setsession(latitude, longitude, custmerloginstatus, address);
                                jQuery('#lat').val(latitude);
                                jQuery('#lng').val(longitude);
                              }
                            });
                        this.closeModal();
                        $('#popup-modal').html(" ");
                    }
                }]
            };

            // Registered user popup
            var optionsnew = {
                type: 'popup',
                responsive: true,
                innerScroll: true,
                title: 'Confirm Address',
                modalClass: 'custom-modal-login',
                buttons: [{
                    text: $.mage.__('Confirm'),
                    class: 'getaddressdetailslogin',
                    click: function () {
                        //alert($("input[name='checkaddress']:checked").val());
                        var geocoder = new google.maps.Geocoder();
                            var address = $("input[name='checkaddress']:checked").val();

                            geocoder.geocode( { 'address': address}, function(results, status) {
                               if (status == google.maps.GeocoderStatus.OK) {
                                var latitude = results[0].geometry.location.lat();
                                var longitude = results[0].geometry.location.lng();
                                var custmerloginstatus = 'true';
                                // Clear cart
                                jQuery.ajax({
                                    url: '<?php  echo $baseUrl; ?>search/index/clearcart',
                                    type: 'POST',
                                    showLoader: true,
                                    success: function (res) {
                                        if (res.messages) {
                                            jQuery('[data-placeholder="messages"]').html(res.messages);
                                        }

                                        if (res.minicart) {
                                            jQuery('[data-block="minicart"]').replaceWith(res.minicart);
                                            jQuery('[data-block="minicart"]').trigger('contentUpdated');
                                        }
                                    },
                                    complete:function(){
                                        location.reload();
                                    }
                                });

                                // Set session
                                setsession(latitude, longitude, custmerloginstatus, address);
                                 // $.cookie('latitude', latitude );
                                 // $.cookie('longitude', longitude );
                                 // $.cookie('custmerloginstatus', 'true' );
                                jQuery('#lat').val(latitude);
                                jQuery('#lng').val(longitude);
                              }
                            });
                        this.closeModal();
                        $('#popup-modal-islogin').html(" ");
                    }
                }]
            };
              if($("#lat").val() == '' && $("#lng").val() == '' && sessionLat == 'null' && sessionLng == 'null'){
                    var popup = modal(options, $('#popup-modal'));
                    setTimeout(function() {
                    $('#popup-modal').modal('openModal');
                    }, 5000);
            }   

            // Change header address here
            jQuery('.change-location').click(function(){
                var popup = modal(options, $('#popup-modal'));
                $('#popup-modal').modal('openModal');
            });

            function setsession(latitude, longitude, custmerloginstatus, address){
                if(latitude != '' && longitude != '' && custmerloginstatus != ''){
                var param = 'latitude='+latitude+'&longitude='+longitude+'&custmerloginstatus='+custmerloginstatus+'&fulladdress='+address;
                    jQuery.ajax({
                        showLoader: true,
                        url: "<?php  echo $baseUrl; ?>search/index/session",
                        data: param,
                        type: "POST",
                        dataType: 'json',
                    }).done(function (data) {
                        // console.log(data);
                        if(data.message == 'Success')
                        {
                            console.log("Set session data.");
                            // window.location.reload(true);
                            window.location.href="<?php echo '?time='.time(); ?>";
                        }
                        else
                        {
                            console.log("some problem to set session data");
                        }
                    });
                } //endif
            }//end function setsession
    });
});

</script>